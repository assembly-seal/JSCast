<img src="./building.png" id="building" style="display:none"/>
<script>
    fetch("gamedata.json")
        .then(response => response.json())
        .then(data => engine(data))
        .catch(error => console.error("Error loading JSON file", error));

    function engine(data) {
        const DISPLAY_HEIGHT = data.display_height;
        const DISPLAY_WIDTH  = data.display_width;
        const PLAYER_SPEED   = data.player_speed;
        const RAY_AMOUNT     = data.ray_amount;
        const RAY_LENGTH     = data.ray_length;
        const STEP_SIZE      = data.step_size;    
        const FOV            = data.fov;
        const PI_2           = Math.PI * 2;

        const HALF_FOV     = FOV           / 2;
        const BAR_SIZE     = DISPLAY_WIDTH / RAY_AMOUNT;
        const ANGLE_STEP   = FOV           / RAY_AMOUNT;
        const ANGLE_TO_BAR = ANGLE_STEP    / BAR_SIZE;
        const STEP_COUNT   = RAY_LENGTH    / STEP_SIZE;
        const DIST_COLOR   = 255           / RAY_LENGTH; // inverse of desired color

        const canvas  = document.createElement('canvas');
        canvas.style  = "background:black";
        canvas.height = DISPLAY_HEIGHT;
        canvas.width  = DISPLAY_WIDTH;
        document.body.appendChild(canvas);

        const buildingImg = document.getElementById('building');

        const player = {
            x:      data.playerX,
            y:      data.playerY,
            angle:  data.playerA,
        }

        const map = data.map;

        const buildings = [
            {x: -5, y: -5,  dist: 0},
            {x: -5, y: -12, dist: 0},
        ];

        const ctx        = canvas.getContext('2d');
        const normal     = x                => mod(x, PI_2);
        const dist       = (x1, y1, x2, y2) => Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        const clamp      = (x, min, max)    => Math.min(Math.max(x, min), max);
        const mod        = (a, n) => a - Math.abs(n) * Math.floor(a / Math.abs(n));
        const getColor   = x                => Math.floor(255 - (x * DIST_COLOR));
        const movePlayer = a                => {
            player.x += Math.cos(player.angle + a) * PLAYER_SPEED;
            player.y += Math.sin(player.angle + a) * PLAYER_SPEED;
        }

        const keys       = {};
        const keyList    = ['w', 'a', 's', 'd', 'ArrowLeft', 'ArrowRight'];
        const keyActions = {
            w:          () => movePlayer(0),
            a:          () => movePlayer(Math.PI * 3 / 2),
            s:          () => movePlayer(Math.PI),
            d:          () => movePlayer(Math.PI / 2),
            ArrowLeft:  () => player.angle -= Math.PI / 100,
            ArrowRight: () => player.angle += Math.PI / 100,
        }

        document.addEventListener('keydown', e => keyList.includes(e.key) ? keys[e.key] = true  : 0);
        document.addEventListener('keyup',   e => keyList.includes(e.key) ? keys[e.key] = false : 0);

        function gameLoop() {
            for (let i in keys)
                if (keys[i] === true)
                    keyActions[i]();
            player.angle = mod(player.angle, PI_2);

            ctx.clearRect(0, 0, DISPLAY_WIDTH, DISPLAY_HEIGHT);

            for (let building of buildings)
                building.dist = dist(player.x, player.y, building.x, building.y);

            buildings.sort((a, b) => b.dist - a.dist);

            for (let building of buildings) {
                const buildingAngle         = Math.atan2(building.y - player.y, building.x - player.x);
                const angleOffset           = buildingAngle - player.angle;
                const relativeAngle         = mod(angleOffset + HALF_FOV, PI_2);
                if (relativeAngle > FOV) continue;

                const sizeMultiplier = 20 / building.dist;
                const height         = 227 * sizeMultiplier;
                const wallHeight     = DISPLAY_HEIGHT / (building.dist * Math.cos(angleOffset));
                const base           = wallHeight + (DISPLAY_HEIGHT - wallHeight) / 2;
                ctx.drawImage(
                    buildingImg,
                    relativeAngle / ANGLE_TO_BAR - 75 * sizeMultiplier,
                    base - height,
                    150 * sizeMultiplier,
                    227 * sizeMultiplier
                );
            }

            let rayAngle = player.angle - FOV / 2;
            for (let i = 0; i < RAY_AMOUNT; i++) {
                const x_step = Math.cos(rayAngle) * STEP_SIZE;
                const y_step = Math.sin(rayAngle) * STEP_SIZE;
                let endX     = player.x;
                let endY     = player.y;

                for (let j = 0; j < STEP_COUNT; j++) {
                    if (map[Math.floor(endY)][Math.floor(endX)]) break;
                    endX += x_step;
                    endY += y_step;
                }

                const distance = dist(player.x, player.y, endX, endY);
                const height   = DISPLAY_HEIGHT / (distance * Math.cos(rayAngle - player.angle));
                const color    = getColor(distance);

                ctx.fillStyle = `rgb(${color}, 0, ${color})`;
                ctx.fillRect(BAR_SIZE * i, (DISPLAY_HEIGHT - height) / 2, BAR_SIZE + 1, height);

                rayAngle += ANGLE_STEP;
            }

            window.requestAnimationFrame(gameLoop);
        } window.requestAnimationFrame(gameLoop);
    }
</script>